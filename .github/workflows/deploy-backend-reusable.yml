name: Deploy Backend (Reusable)

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to deploy to (test or prod)'
        required: true
        type: string
      region:
        description: 'Azure region'
        required: false
        type: string
        default: 'westus2'
      image_tag:
        description: 'Full Docker image tag to deploy (registry/repo:tag)'
        required: true
        type: string
    secrets:
      AZURE_CREDENTIALS:
        required: true
      AZURE_STORAGE_CONNECTION_STRING:
        required: true

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Generate resource names from environment
        id: resources
        run: |
          ENV="${{ inputs.environment }}"
          REGION="${{ inputs.region }}"

          CONTAINER_APP="ca-msscfg-${ENV}"
          RESOURCE_GROUP="rg-msscfg-${ENV}-${REGION}"

          echo "container-app=${CONTAINER_APP}" >> $GITHUB_OUTPUT
          echo "resource-group=${RESOURCE_GROUP}" >> $GITHUB_OUTPUT
          echo "region=${REGION}" >> $GITHUB_OUTPUT

          echo "### Deployment to ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: \`${{ inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ inputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Container App**: \`${CONTAINER_APP}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Resource Group**: \`${RESOURCE_GROUP}\`" >> $GITHUB_STEP_SUMMARY

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure Container Apps
        uses: azure/container-apps-deploy-action@v1
        with:
          containerAppName: ${{ steps.resources.outputs.container-app }}
          resourceGroup: ${{ steps.resources.outputs.resource-group }}
          imageToDeploy: ${{ inputs.image_tag }}
          environmentVariables: |
            ENVIRONMENT=${{ inputs.environment }}
            AZURE_STORAGE_CONNECTION_STRING=${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}

      - name: Health check
        run: |
          APP_URL=$(az containerapp show \
            --name ${{ steps.resources.outputs.container-app }} \
            --resource-group ${{ steps.resources.outputs.resource-group }} \
            --query properties.configuration.ingress.fqdn \
            --output tsv)

          # Retry loop for health check (Container Apps can take time to start)
          MAX_RETRIES=30
          RETRY_DELAY=10

          for i in $(seq 1 $MAX_RETRIES); do
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://${APP_URL}/health || echo "000")

            if [ "$RESPONSE" -eq 200 ]; then
              echo "### Health Check: PASSED ✅" >> $GITHUB_STEP_SUMMARY
              echo "- **Endpoint**: \`https://${APP_URL}/health\`" >> $GITHUB_STEP_SUMMARY
              echo "- **Status Code**: \`${RESPONSE}\`" >> $GITHUB_STEP_SUMMARY
              echo "- **Image Deployed**: \`${{ inputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
              echo "- **Attempts**: \`${i}/${MAX_RETRIES}\`" >> $GITHUB_STEP_SUMMARY
              exit 0
            fi

            echo "Attempt ${i}/${MAX_RETRIES}: Got ${RESPONSE}, retrying in ${RETRY_DELAY}s..."
            sleep $RETRY_DELAY
          done

          echo "### Health Check: FAILED ❌" >> $GITHUB_STEP_SUMMARY
          echo "Health check failed after ${MAX_RETRIES} attempts" >> $GITHUB_STEP_SUMMARY
          exit 1
