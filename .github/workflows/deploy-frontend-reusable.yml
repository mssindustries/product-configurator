name: Deploy Frontend (Reusable)

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to deploy to (test or prod)'
        required: true
        type: string
      is-preview:
        description: 'Whether this is a PR preview deployment'
        required: false
        type: boolean
        default: false
    secrets:
      AZURE_STATIC_WEB_APPS_API_TOKEN:
        required: true

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: src/frontend/package-lock.json

      - name: Install dependencies
        working-directory: src/frontend
        run: npm ci

      - name: Build application
        working-directory: src/frontend
        run: npm run build -- --mode ${{ inputs.environment }}

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: ${{ github.event_name == 'pull_request' && github.event.action == 'closed' && 'close' || 'upload' }}
          app_location: "src/frontend/dist"
          skip_app_build: true
          api_location: ""
          production_branch: "main"

      - name: Deployment summary
        if: ${{ !inputs.is-preview }}
        run: |
          echo "### Deployment Complete ✅" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: \`${{ inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Build Mode**: \`${{ inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY

      - name: Preview deployment summary
        if: ${{ inputs.is-preview }}
        run: |
          echo "### PR Preview Deployed ✅" >> $GITHUB_STEP_SUMMARY
          echo "Preview URL will be posted in PR comment by Azure action" >> $GITHUB_STEP_SUMMARY
